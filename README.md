# WB Analytics - ETL Pipeline

‚öôÔ∏è ETL –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö –∏–∑ Wildberries (–∏ Ozon –≤ –±—É–¥—É—â–µ–º) –≤ Supabase.

## üìã –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- **Python 3.9+**
- –ö–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ –∫ Wildberries API
- Supabase URL –∏ API –∫–ª—é—á
- (–û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ) OpenAI API –∫–ª—é—á –¥–ª—è LLM —Ñ—É–Ω–∫—Ü–∏–π

## üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è

```bash
git clone <repository-url>
cd wb-analytics
```

### 2. –°–æ–∑–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è

–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª `.env` –≤ –∫–æ—Ä–Ω–µ –ø—Ä–æ–µ–∫—Ç–∞:

```env
# Supabase
SUPABASE_URL=https://<your-project>.supabase.co
SUPABASE_SERVICE_ROLE_KEY=<your-service-role-key>
# –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ SUPABASE_ANON_KEY –µ—Å–ª–∏ SERVICE_ROLE –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

# Wildberries API
WB_KEY=<your-wb-api-key>

# Logging
LOG_LEVEL=INFO
LOG_TO_FILE=true

# Pipeline flags
RUN_ADVERTS_SETTINGS=true
RUN_SALES_FUNNEL=true
RUN_ADVERTS_FULLSTATS=false
RUN_SPP=false

# Advanced settings (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
SLEEP_SECONDS=21
FULLSTATS_SLEEP_SECONDS=15
FULLSTATS_CHUNK_SIZE=50
BATCH_SIZE=500
OVERLAP_DAYS=2
```

### 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

```bash
pip install -r requirements.txt
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ó–∞–ø—É—Å–∫ ETL Pipeline

```bash
python -m src.etl.main
```

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:
1. ‚úÖ –ß–∏—Ç–∞–µ—Ç –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –∏–∑ `.env`
2. ‚úÖ –ü–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ Wildberries API
3. ‚úÖ –ü–æ–ª—É—á–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–π –¥–µ–Ω—å (–∏–ª–∏ —É–∫–∞–∑–∞–Ω–Ω—ã–π –¥–∏–∞–ø–∞–∑–æ–Ω)
4. ‚úÖ –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
5. ‚úÖ –ó–∞–≥—Ä—É–∂–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –≤ Supabase

### GitHub Actions

–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 07:00 –ø–æ –ú–æ—Å–∫–≤–µ (UTC+3):
- –§–∞–π–ª: `.github/workflows/etl_daily.yml`
- –í—Å–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ GitHub Secrets

## üìä –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –î–∞–Ω–Ω—ã–µ

### Wildberries

| –î–∞–Ω–Ω—ã–µ | –¢–∞–±–ª–∏—Ü–∞ | –§–ª–∞–≥ |
|--------|---------|------|
| Sales Funnel | `wb_sales_funnel_products` | `RUN_SALES_FUNNEL` |
| –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –≤–∏–∑—ã | `wb_adv_fullstats_daily` | `RUN_ADVERTS_FULLSTATS` |
| –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–∞–º–ø–∞–Ω–∏–π | `wb_adverts_nm_settings` | `RUN_ADVERTS_SETTINGS` |
| SPP Snapshot | `wb_spp_daily` | `RUN_SPP` |

### Ozon (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)

- üîú –ü–ª–∞–Ω–∏—Ä—É–µ—Ç—Å—è –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–¥–¥–µ—Ä–∂–∫—É Ozon API –≤ –±—É–¥—É—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö

## üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–æ –Ω–∞ –º–æ–¥—É–ª—å–Ω–æ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ:

```
src/
‚îú‚îÄ‚îÄ config/           # Pydantic –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
‚îú‚îÄ‚îÄ logging_config/   # –°–∏—Å—Ç–µ–º–∞ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
‚îú‚îÄ‚îÄ core/             # –ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ –∫–ª–∞—Å—Å—ã –∏ –∏—Å–∫–ª—é—á–µ–Ω–∏—è
‚îú‚îÄ‚îÄ connectors/       # –ö–æ–Ω–Ω–µ–∫—Ç–æ—Ä—ã –∫ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–∞–º (WB, Ozon)
‚îú‚îÄ‚îÄ database/         # –†–∞–±–æ—Ç–∞ —Å –ë–î (–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
‚îú‚îÄ‚îÄ etl/              # –ü–∞–π–ø–ª–∞–π–Ω—ã ETL
‚îÇ   ‚îú‚îÄ‚îÄ main.py       # –ì–ª–∞–≤–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞
‚îÇ   ‚îî‚îÄ‚îÄ transformers.py # –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä—ã –¥–∞–Ω–Ω—ã—Ö
‚îî‚îÄ‚îÄ utils/            # –£—Ç–∏–ª–∏—Ç—ã (retry, date_utils)
```

### –ö–ª—é—á–µ–≤—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

**Connectors**: –ü–æ–ª—É—á–∞—é—Ç –¥–∞–Ω–Ω—ã–µ –∏–∑ API –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤
- `WBConnector` - Wildberries API
- `OzonConnector` - Ozon API (placeholder)

**Transformers**: –¢—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∏—Ä—É—é—Ç —Å—ã—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
- `WBTransformer.transform_sales_funnel()`
- `WBTransformer.transform_adverts()`
- `WBTransformer.transform_fullstats_days()`
- `WBTransformer.transform_spp_snapshot()`

**Pipelines**: –û—Ä–∫–µ—Å—Ç—Ä–∏—Ä—É—é—Ç –ø—Ä–æ—Ü–µ—Å—Å –∑–∞–≥—Ä—É–∑–∫–∏
- `run_adverts_settings_pipeline()`
- `run_sales_funnel_pipeline()`
- `run_fullstats_pipeline()`
- `run_spp_pipeline()`

## üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ª–æ–≥–∏—Ä—É–µ—Ç –≤—Å–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:
- **Console output** - –≤—Å–µ–≥–¥–∞ –∞–∫—Ç–∏–≤–µ–Ω
- **File logs** - —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ `logs/app.log` (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–£—Ä–æ–≤–Ω–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è: DEBUG, INFO, WARNING, ERROR, CRITICAL

–ü—Ä–∏–º–µ—Ä –ª–æ–≥–∞:
```
2026-01-18 17:05:23 [INFO    ] src.etl.main: Starting ETL Application
2026-01-18 17:05:24 [INFO    ] src.connectors.wb: [wildberries] Fetched sales funnel data: 2026-01-17 -> 2026-01-17
2026-01-18 17:05:25 [INFO    ] src.etl.main: ‚úÖ Sales funnel pipeline completed: 1250 total records upserted
```

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

```bash
# –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤
pytest

# –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤ —Å –ø–æ–∫—Ä—ã—Ç–∏–µ–º
pytest --cov=src

# –ó–∞–ø—É—Å–∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Ç–µ—Å—Ç–∞
pytest tests/test_transformers.py::TestSalesFunnelTransformer::test_transform_sales_funnel_basic
```

## üîÑ Retry –õ–æ–≥–∏–∫–∞

–°–µ—Ç–µ–≤—ã–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–≤—Ç–æ—Ä—è—é—Ç—Å—è (–º–∞–∫—Å–∏–º—É–º 3 –ø–æ–ø—ã—Ç–∫–∏):

```python
@retry_on_exception(exception_types=(httpx.HTTPError,), max_retries=3, delay_seconds=5)
def fetch_sales_funnel(self, start: str, end: str):
    # –§—É–Ω–∫—Ü–∏—è –±—É–¥–µ—Ç –ø–æ–≤—Ç–æ—Ä–µ–Ω–∞ –¥–æ 3 —Ä–∞–∑ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    ...
```

## üö¶ –°—Ç–∞—Ç—É—Å—ã –ö–∞–º–ø–∞–Ω–∏–π

- `7` - Paused (–ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞)
- `9` - Active (–∞–∫—Ç–∏–≤–Ω–∞)
- `11` - Completed (–∑–∞–≤–µ—Ä—à–µ–Ω–∞)

## üì¶ –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –∏ –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã WB –¥–∞–Ω–Ω—ã—Ö

1. –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–æ–¥ –≤ `WBConnector` –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
2. –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–µ—Ä –≤ `WBTransformer`
3. –î–æ–±–∞–≤–∏—Ç—å pipeline —Ñ—É–Ω–∫—Ü–∏—é –≤ `src/etl/main.py`
4. –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –≤ `src/config/settings.py`

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ Ozon –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏

1. –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ç–æ–¥—ã –≤ `OzonConnector`
2. –°–æ–∑–¥–∞—Ç—å `OzonTransformer` —Å –º–µ—Ç–æ–¥–∞–º–∏ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
3. –î–æ–±–∞–≤–∏—Ç—å pipeline –¥–ª—è Ozon –≤ `main.py`
4. –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –≤ settings

## ‚ö†Ô∏è –ò–∑–≤–µ—Å—Ç–Ω—ã–µ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

- WB API –∏–º–µ–µ—Ç rate limiting (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è 21+ —Å–µ–∫ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏)
- Fullstats –¥–∞–Ω–Ω—ã–µ —á–∞–Ω–∫–∏—Ä—É—é—Ç—Å—è –ø–æ 50 –∫–∞–º–ø–∞–Ω–∏–π
- SPP –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –≤—á–µ—Ä–∞—à–Ω–µ–≥–æ –¥–Ω—è (+overlap_days)

## üìû –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ—à–∏–±–æ–∫:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ –≤ `logs/app.log`
2. –£–±–µ–¥–∏—Ç–µ—Å—å —á—Ç–æ –≤—Å–µ –∫–ª—é—á–∏ API –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
4. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏ —Å –ª–æ–≥–∞–º–∏ –∏ –æ–ø–∏—Å–∞–Ω–∏–µ–º

## üìÖ –í–µ—Ä—Å–∏—è

**v2.0** - –ü–æ–ª–Ω—ã–π —Ä–µ—Ñ–∞–∫—Ç–æ—Ä–∏–Ω–≥ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π —Ä–∞—Å—à–∏—Ä–µ–Ω–∏—è

**–ò—Å—Ç–æ—Ä–∏—è –∏–∑–º–µ–Ω–µ–Ω–∏–π:**
- v2.0 (2026-01-18): –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –º–æ–¥—É–ª—å–Ω—É—é –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É (Pydantic, Loggers, BaseConnector)
- v1.0: –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è —Å basic —Ñ—É–Ω–∫—Ü–∏—è–º–∏
